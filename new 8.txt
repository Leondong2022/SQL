WITH tmp1 AS (select registno,substr(COMCODE,1,4)COM,POLICYNO,CLASSCODE,
case when substr(comcode,1,2) = '44' then '广东省' end shengfen,
DAMAGESTARTDATE,substr(to_char(DAMAGESTARTDATE,'YYYYMMDD'),1,4)DAMAGEYEAR,DAMAGEADDRESS,
RISKCODE,CLAIMNO,SUMPAID from AGRIUSER.NX_LAJBXXB where substr(comcode,1,4)
= '4418'),
tmp2 AS (select registno,COMPENSATENO,COMPENSATETYPE from AGRIUSER.NX_PKJSSB
where to_char(UNDERWRITEENDDATE,'YYYY-MM-DD') between '2022-01-01' and '2022-10-31'
and UNDERWRITEFLAG = '1'),
tmp3 AS (select a.udid,b.registno from AGRIUSER.NX_YZXCKSSMXB a left join
AGRIUSER.NX_YZXLSSSJBXXB b on a.LISTNO = b.LISTNO),
tmp4 AS (select registno,REPORTDATE from AGRIUSER.NX_BAXXB),
tmp5 AS (select registno,PAYEENAME,IDENTIFYNUMBER from AGRIUSER.NX_LKRXXB),
tmp7 AS (SELECT POLICYNO,DAMAGESTARTDATE,SUMPAID,PAYEENAME,count(1) FROM (
(select registno,substr(COMCODE,1,4)COM,POLICYNO,CLASSCODE,
case when substr(comcode,1,2) = '44' then '广东省' end shengfen,
DAMAGESTARTDATE,substr(DAMAGESTARTDATE,1,4)DAMAGEYEAR,DAMAGEADDRESS,
RISKCODE,CLAIMNO,SUMPAID from AGRIUSER.NX_LAJBXXB where substr(comcode,1,4)
= '4418')a RIGHT JOIN (SELECT registno,PAYEENAME FROM AGRIUSER.NX_LKRXXB)b ON
a.registno = b.registno)
GROUP BY POLICYNO,DAMAGESTARTDATE,SUMPAID,PAYEENAME
HAVING count(1) > 1),
tmp8 AS (SELECT a.registno,POLICYNO,DAMAGESTARTDATE,SUMPAID,PAYEENAME FROM (
(select registno,substr(COMCODE,1,4)COM,POLICYNO,CLASSCODE,
case when substr(comcode,1,2) = '44' then '广东省' end shengfen,
DAMAGESTARTDATE,substr(DAMAGESTARTDATE,1,4)DAMAGEYEAR,DAMAGEADDRESS,
RISKCODE,CLAIMNO,SUMPAID from AGRIUSER.NX_LAJBXXB where substr(comcode,1,4)
= '4418')a RIGHT JOIN (SELECT registno,PAYEENAME FROM AGRIUSER.NX_LKRXXB)b ON
a.registno = b.registno))
SELECT tmp3.registno,COM,POLICYNO,CLASSCODE,shengfen,
DAMAGESTARTDATE,DAMAGEYEAR,DAMAGEADDRESS,
RISKCODE,CLAIMNO,SUMPAID,COMPENSATENO,COMPENSATETYPE,REPORTDATE,PAYEENAME,IDENTIFYNUMBER,udid FROM 
(SELECT tmp5.registno,COM,POLICYNO,CLASSCODE,shengfen,
DAMAGESTARTDATE,DAMAGEYEAR,DAMAGEADDRESS,
RISKCODE,CLAIMNO,SUMPAID,COMPENSATENO,COMPENSATETYPE,REPORTDATE,PAYEENAME,IDENTIFYNUMBER FROM 
(SELECT tmp4.registno,COM,POLICYNO,CLASSCODE,shengfen,
DAMAGESTARTDATE,DAMAGEYEAR,DAMAGEADDRESS,
RISKCODE,CLAIMNO,SUMPAID,COMPENSATENO,COMPENSATETYPE,REPORTDATE FROM (SELECT tmp1.registno,COM,POLICYNO,CLASSCODE,shengfen,
DAMAGESTARTDATE,DAMAGEYEAR,DAMAGEADDRESS,
RISKCODE,CLAIMNO,SUMPAID,COMPENSATENO,COMPENSATETYPE FROM tmp1 
INNER JOIN tmp2 ON tmp1.registno = tmp2.registno)A 
INNER JOIN tmp4 ON A.registno = tmp4.registno)B 
INNER JOIN tmp5 ON B.REGISTNO = tmp5.registno)C 
INNER JOIN tmp3 ON C.registno = tmp3.registno
WHERE tmp3.registno IN (SELECT tmp8.registno FROM tmp8
INNER JOIN 
tmp7 ON tmp8.POLICYNO = tmp7.POLICYNO AND tmp8.DAMAGESTARTDATE = tmp7.DAMAGESTARTDATE
AND tmp8.SUMPAID = tmp7.SUMPAID AND tmp8.PAYEENAME = tmp7.PAYEENAME)
ORDER BY POLICYNO