-- Oracle中Start with...Connect By实现部门多级递归理解及用法
--基本语法是：
select ... from tablename start with cond1
connect by PRIOR cond2
where cond3;
-- 简单说来是将一个树状结构存储在一张表里，用上述语法的查询可以取得这棵树的所有记录。
-- 其中COND1是根结点的限定语句，COND2是连接条件，其中用PRIOR表示上一条记录。
-- COND3是过滤条件，用于对返回的所有记录进行过滤。


SELECT *
FROM EMP T WHERE T.EMPNO = 7566;
    7566 项目经理
7902   7788 小组长 1
7369   7876 搬砖的 2
1234   5678 临时工 3


---PRIOR 侧的字段是 EMPNO(儿子)，就是往下属寻找
SELECT EMPNO,ENAME,MGR
       ,LEVEL 层次  -- 用数字表示在树状数据中的层次  伪劣
       ,SYS_CONNECT_BY_PATH(T.ENAME,'=>') 递进关系
FROM EMP T
START WITH T.EMPNO = 7566 ---表示从哪些数据开始找
---START WITH T.MGR = 7566
CONNECT BY  PRIOR T.EMPNO = T.MGR;

-- 从董事长，往下找
SELECT EMPNO,ENAME,MGR
       ,LEVEL 层次
       ,SYS_CONNECT_BY_PATH(T.ENAME,'=>') 递进关系
FROM EMP T
START WITH t.EMPNO = 7839 ---表示从哪些数据开始找
CONNECT BY  PRIOR T.EMPNO =T.MGR  ;

-- 从7788开始，往上找
SELECT EMPNO,ENAME,MGR
       ,LEVEL 层次
       ,SYS_CONNECT_BY_PATH(T.ENAME,'=>') 递进关系
FROM EMP T
START WITH t.EMPNO = 7788 ---表示从哪些数据开始找
CONNECT BY  PRIOR T.MGR = T.EMPNO ;


select ENAME from EMP where MGR = 7566;


---练习
CREATE TABLE SC_DISTRICT
(
  ID         NUMBER(10)                  NOT NULL,
  PARENT_ID  NUMBER(10),
  NAME       VARCHAR2(255 BYTE)          NOT NULL
);

INSERT INTO SC_DISTRICT VALUES(1,NULL,'四川省');

INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(2,1,'巴中市');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(3,1,'达州市');

INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(4,2,'巴州区');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(5,2,'通江县');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(6,2,'平昌县');

INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(7,3,'通川区');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(8,3,'宣汉县');

INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(9,8,'塔河乡');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(10,8,'三河乡');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(11,8,'胡家镇');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(12,8,'南坝镇');

INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(13,6,'大寨乡');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(14,6,'响滩镇');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(15,6,'龙岗镇');
INSERT INTO SC_DISTRICT(ID,PARENT_ID,NAME) VALUES(16,6,'白衣镇');

COMMIT;

SELECT * FROM SC_DISTRICT;

-- 1. 找出 巴中市的所有下属区域
select T.*, LEVEL 层级, SYS_CONNECT_BY_PATH(T.NAME, '=>') 递进关系
from SC_DISTRICT T
START WITH T.NAME = '巴中市'
CONNECT BY PRIOR T.ID = T.PARENT_ID;

-- 2.找出 白衣镇 的所有上级（父级）区域

select T.*, LEVEL 层级, SYS_CONNECT_BY_PATH(T.NAME, '=>') 递进关系
from SC_DISTRICT T
START WITH NAME = '白衣镇'
CONNECT BY   T.ID = PRIOR T.PARENT_ID ;

-- 3. 找出 宣汉县 的所有上级（父级）区域
SELECT T.*
       ,LEVEL
       ,SYS_CONNECT_BY_PATH(T.NAME,'=>')
FROM SC_DISTRICT T
START WITH T.NAME = '宣汉县'
CONNECT BY  PRIOR T.PARENT_ID = T.ID;